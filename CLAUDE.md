# Claude Code Instructions for distraction-filters

> **Note**: This file should always be updated with new learnings about filter syntax, site-specific quirks, and testing approaches.

## Project Overview

This repo contains cosmetic filters for uBlock Origin and AdGuard that:
1. Hide distracting UI elements (sidebars, feeds, recommendations)
2. Apply dark themes (Dracula) to specific sites

## Filter Syntax Reference

### Compatibility: uBlock Origin vs AdGuard

Both support the same core cosmetic filter syntax. The filters here use only the common subset.

### Basic Syntax

```
domain.com##selector           # Hide element matching CSS selector
domain.com##selector:style(css)  # Apply inline CSS instead of hiding
```

### Supported Selectors (both uBlock & AdGuard)

| Type | Example | Description |
|------|---------|-------------|
| Element | `##div` | All divs |
| Class | `##.sidebar` | Elements with class |
| ID | `###header` | Element with ID |
| Attribute | `##[role="complementary"]` | Attribute selector |
| Descendant | `##.parent .child` | Nested elements |
| Pseudo-class | `##a:visited` | CSS pseudo-classes |

### The `:style()` Procedural Cosmetic

```
domain.com##selector:style(property: value !important;)
```

- Use `!important` to override site styles
- Multiple properties separated by semicolons
- Must end with `)` - incomplete rules break the filter

### Comments

```
! This is a comment
! Title: Section Name
```

## Known Issues & Learnings

### hckrnews.com
- **Fixed 2026-01-27**: Line 42 had incomplete CSS rule (missing border color and closing paren)
- **Updated 2026-01-28**: Switched to Catppuccin Mocha for better accessibility
- **Key decision**: Keep orange for points/active tabs (preserves semantic "popularity" meaning)
- Site uses `.entries.io` class for story entries
- Time markers use `.link span` inside entries
- Filter tabs use `.filters a` with `.active` class for selected state
- Auto-refresh indicator uses `.autorefresh` class
- "Last Visit" marker appears between entries

### Hacker News (news.ycombinator.com)
- Uses table-based layout with `bgcolor` attributes
- Main content in `#hnmain`
- Orange header bar: `td[bgcolor="#ff6600"]`

### Reddit
- New Reddit uses web components (`shreddit-*`, `faceplate-*`)
- Old Reddit uses traditional classes (`.side`, `.menuarea`)
- Both need separate rules

### YouTube
- **Tested 2026-01-27**: Desktop YouTube works in Playwright (not blocked)
- Heavily dynamic, elements load async
- Player controls: `.ytp-*` classes
- Desktop elements (sidebar, header) are commented out - only player distractions active
- Mobile site (`m.youtube.com`) has more active filters - different structure
- Player filters (next button, suggestions, endscreen) only visible during hover/video end

### Reddit
- **Tested 2026-01-27**: Blocked by Reddit (403 error) in standard Playwright
- **Workarounds**: `playwright-extra` + stealth plugin, or residential proxies (see https://www.zenrows.com/blog/playwright-stealth)
- **Recommendation**: For CSS filter testing, manual DevTools testing is simpler than stealth infrastructure
- New Reddit uses web components (`shreddit-*`, `faceplate-*`)
- Old Reddit uses traditional classes (`.side`, `.menuarea`)
- Both need separate rules

## Testing Approaches

### Quick Manual Testing
1. Open browser DevTools (F12)
2. Go to Elements panel
3. Add `<style>` block with your CSS
4. Or use uBlock Origin's "element picker" mode

### Using Playwright for Automated Testing
For repeatable testing, inject CSS via Playwright:

```javascript
const { chromium } = require('playwright');

(async () => {
  const browser = await chromium.launch({ headless: false });
  const page = await browser.newPage();

  // Navigate first
  await page.goto('https://hckrnews.com');

  // Inject custom CSS
  await page.addStyleTag({
    content: `
      body, #page { background-color: #21222c !important; color: #f8f8f2 !important; }
      .link.story { color: #8be9fd !important; }
    `
  });

  // Take screenshot for verification
  await page.screenshot({ path: 'hckrnews-themed.png' });

  await browser.close();
})();
```

### Converting Filters to CSS for Testing

The `:style()` filters can be extracted to plain CSS:

```
hckrnews.com##body:style(background: #21222c !important;)
```

Becomes:

```css
body { background: #21222c !important; }
```

## File Structure

- `social.txt` - Main filter list for social/news sites
- `generate-test-css.js` - Generate console commands for manual testing (recommended)
- `test-filters.js` - Playwright-based automated screenshot testing
- `test-commands.md` - Pre-generated console commands for all sites (generated by --all)
- `README.md` - User-facing documentation
- `CLAUDE.md` - This file (development notes)

## Testing Filters

### Quick Manual Testing (Recommended)

Use `generate-test-css.js` to create copy-paste console commands:

```bash
# List all domains and their rule counts
node generate-test-css.js

# Generate console command for a specific site
node generate-test-css.js hckrnews

# Generate all commands to test-commands.md
node generate-test-css.js --all
```

Then:
1. Open the target site in your browser
2. Open DevTools (F12) > Console
3. Paste the generated command
4. To remove: paste the remove command

**For mobile sites** (m.youtube.com): Use DevTools device toolbar (Ctrl+Shift+M) to emulate mobile viewport before testing.

### Automated Playwright Testing

Use `test-filters.js` for automated screenshot comparison:

```bash
# Requires: npm install playwright
node test-filters.js --list
node test-filters.js hckrnews        # Generate before/after screenshots
node test-filters.js hn --headed     # Test with visible browser
```

**Note**: Reddit blocks Playwright (403). Use manual DevTools testing for Reddit.

### GitHub Workflow (Automatic)

When `social.txt` is pushed to main, a GitHub Action automatically:
1. Creates a new issue titled "ðŸ§ª Test filters: YYYY-MM-DD"
2. Adds a comment for each domain with copy-paste console commands
3. Each comment has checkboxes to track testing progress

Just close the issue when testing is complete.

**Setup**: Create a `testing` label in the repo (the workflow uses it).

## Adding New Filters

1. Add a comment header: `! sitename`
2. Group hiding rules first, then `:style()` theming rules
3. Test in browser DevTools before committing
4. Update this file with any site-specific learnings

## Sites Covered

| Site | Hiding | Theme |
|------|--------|-------|
| news.ycombinator.com | Yes | Dracula |
| hckrnews.com | No | Catppuccin Mocha |
| reddit.com | Yes | No |
| old.reddit.com | Yes | No |
| facebook.com | Yes | No |
| youtube.com | Yes | No |
| m.youtube.com | Yes | No |

## Theme Accessibility Notes

- **Preserve semantic colors**: If the original site uses color to convey meaning (e.g., orange = popularity), keep that color in the dark theme
- **Contrast ratios**: Aim for WCAG AA (4.5:1 for normal text, 3:1 for large text)
- **Catppuccin Mocha** is preferred over strict Dracula for better accessibility:
  - Background: `#1e1e2e`
  - Text: `#cdd6f4` (11.5:1 contrast ratio)
  - Muted: `#9399b2`
  - Links: `#89b4fa` (blue), `#89dceb` (cyan)
  - Accent: `#a6e3a1` (green), `#fab387` (peach/orange)
